<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§ä¼šè¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; }
        .tab-btn.active { color: #007bff; border-bottom: 2px solid #007bff; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }

        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin-top: 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }

        .record-card { border: 1px solid #ddd; padding: 10px; margin-top: 10px; border-radius: 4px; background: #fafafa; }
        .record-header { display: flex; justify-content: space-between; font-size: 0.8em; color: #888; }
        .record-title { font-weight: bold; margin: 5px 0; }
        .match-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; color: white; }
        
        .bg-blue { background-color: #007bff; }   /* å¯¾æˆ¦ */
        .bg-green { background-color: #28a745; }  /* è¦³æˆ¦ */
        .bg-orange { background-color: #fd7e14; } /* äº‹å‰æƒ…å ± */

        #loading { text-align: center; color: #666; margin-top: 20px; }
        .no-data { text-align: center; color: #999; margin-top: 20px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
    <meta name="robots" content="noindex">
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="showPage('input')">å…¥åŠ›</button>
        <button class="tab-btn" onclick="showPage('search')">æ¤œç´¢ãƒ»é–²è¦§</button>
        <button class="tab-btn" onclick="showPage('register')">è¨­å®š</button>
    </div>

    <div id="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>

    <div id="page-input" class="page active">
        <label>æ—¥ä»˜</label>
        <input type="date" id="input-date" readonly>

        <label>åŒºåˆ†</label>
        <select id="input-type">
            <option value="å¯¾æˆ¦âš”ï¸">å¯¾æˆ¦âš”ï¸</option>
            <option value="è¦³æˆ¦ğŸ‘€">è¦³æˆ¦ğŸ‘€</option>
            <option value="äº‹å‰æƒ…å ±ğŸ”">äº‹å‰æƒ…å ±ğŸ”</option>
        </select>

        <label>ç›¸æ‰‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å (æ¤œç´¢å¯èƒ½)</label>
        <input type="text" id="input-opponent" list="player-list" placeholder="åå‰ã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠ">
        <datalist id="player-list"></datalist>

        <label>ãƒ‡ãƒƒã‚­å</label>
        <input type="text" id="input-summary" placeholder="ä¾‹ï¼šéå»ã€LO">

        <label>è©³ç´°ãƒ¡ãƒ¢</label>
        <textarea id="input-note" rows="4" placeholder="æ¡ç”¨ã‚«ãƒ¼ãƒ‰ã‚„æšæ•°ã€æ³¨æ„ç‚¹ã€å‹å› ãªã©"></textarea>

        <button onclick="submitRecord()">é€ä¿¡ã™ã‚‹</button>
    </div>

    <div id="page-search" class="page">
        <label>æ—¥ä»˜ã§çµã‚Šè¾¼ã¿</label>
        <select id="search-date" onchange="filterRecords()">
            <option value="all">å…¨æ—¥ç¨‹</option>
        </select>

        <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã§çµã‚Šè¾¼ã¿</label>
        <input type="text" id="search-player" list="player-list-search" placeholder="åå‰ã‚’å…¥åŠ›ï¼ˆç©ºæ¬„ã§å…¨å“¡ï¼‰" oninput="filterRecords()">
        <datalist id="player-list-search"></datalist>

        <div id="records-container"></div>
    </div>

    <div id="page-register" class="page">
        <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç™»éŒ²</h3>
        <p style="font-size:0.9em; color:#666;">
            Tonamelã®å‚åŠ è€…ä¸€è¦§ãªã©ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>
            (æ”¹è¡ŒåŒºåˆ‡ã‚Šã§è¤‡æ•°ä¸€æ‹¬ç™»éŒ²ã§ãã¾ã™)
        </p>
        <textarea id="reg-names" rows="10" placeholder="é¸æ‰‹A&#13;é¸æ‰‹B&#13;é¸æ‰‹C..."></textarea>
        <button onclick="registerPlayers()" class="secondary">ãƒªã‚¹ãƒˆã«ç™»éŒ²</button>
    </div>
</div>

<script>
    // â˜…â˜…â˜…ã“ã“ã«GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„â˜…â˜…â˜…
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyP25ibEiHY4GQKihuEikxNA5qZWim-5V4UYYHy0uefsKxc29_Hg1j0iV5micfddMiF/exec";

    let allRecords = [];
    let allPlayers = [];

    window.onload = async function() {
        document.getElementById('input-date').valueAsDate = new Date();
        await fetchData();
    };

    function showPage(pageName) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('page-' + pageName).classList.add('active');
        event.target.classList.add('active');
    }

    async function fetchData() {
        document.getElementById('loading').style.display = 'block';
        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            
            allPlayers = data.players;
            allRecords = data.records;

            updatePlayerDropdowns();
            updateDateDropdown();
            filterRecords();

        } catch (e) {
            alert("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—: " + e);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // [1] é€ä¿¡å‡¦ç†
    async function submitRecord() {
        const btn = event.target;
        const opponentName = document.getElementById('input-opponent').value.trim();

        if(!opponentName) {
            alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }

        // â˜…æ”¹è‰¯: æœªç™»éŒ²ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç¢ºèªãƒ­ã‚¸ãƒƒã‚¯
        let confirmMsg = "è¨˜éŒ²ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ";
        if (!allPlayers.includes(opponentName)) {
            confirmMsg = `ã€æ³¨æ„ã€‘\nã€Œ${opponentName}ã€ã¯åç°¿ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nã“ã®ã¾ã¾é€ä¿¡ã™ã‚‹ã¨ã€æ–°è¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦åç°¿ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
        }

        if(!confirm(confirmMsg)) return;

        btn.disabled = true;
        btn.innerText = "é€ä¿¡ä¸­...";

        const payload = {
            action: "register_record",
            date: document.getElementById('input-date').value,
            match_type: document.getElementById('input-type').value,
            opponent: opponentName,
            summary: document.getElementById('input-summary').value,
            note: document.getElementById('input-note').value
        };

        try {
            await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            alert("è¨˜éŒ²ã—ã¾ã—ãŸï¼");
            
            document.getElementById('input-opponent').value = "";
            document.getElementById('input-summary').value = "";
            document.getElementById('input-note').value = "";
            
            fetchData();

        } catch (e) {
            alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + e);
        } finally {
            btn.disabled = false;
            btn.innerText = "é€ä¿¡ã™ã‚‹";
        }
    }

    async function registerPlayers() {
        const text = document.getElementById('reg-names').value;
        if(!text) return;
        
        if(!confirm("å…¥åŠ›ã•ã‚ŒãŸåå‰ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ")) return;

        const names = text.split(/\n/).map(s => s.trim()).filter(Boolean);
        
        try {
            const res = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "register_players",
                    names: names
                })
            });
            const json = await res.json();
            alert(json.message);
            document.getElementById('reg-names').value = "";
            fetchData();
        } catch(e) {
            alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + e);
        }
    }

    function updatePlayerDropdowns() {
        // å…¥åŠ›ç”»é¢ç”¨
        const inputList = document.getElementById('player-list');
        inputList.innerHTML = "";
        
        // æ¤œç´¢ç”»é¢ç”¨
        const searchList = document.getElementById('player-list-search');
        searchList.innerHTML = "";

        allPlayers.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            inputList.appendChild(opt.cloneNode(true));
            searchList.appendChild(opt.cloneNode(true));
        });
    }

    function updateDateDropdown() {
        const dates = [...new Set(allRecords.map(r => r.date))].sort();
        const select = document.getElementById('search-date');
        const currentVal = select.value;

        while (select.options.length > 1) select.remove(1);

        dates.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.text = d;
            select.add(opt);
        });
        select.value = currentVal;
    }

    function filterRecords() {
        const dateVal = document.getElementById('search-date').value;
        const playerVal = document.getElementById('search-player').value.trim(); // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚’å–å¾—
        const container = document.getElementById('records-container');
        container.innerHTML = "";

        const filtered = allRecords.filter(r => {
            const isInfo = r.match_type.includes('äº‹å‰æƒ…å ±');
            const matchDate = (dateVal === 'all') || (r.date === dateVal) || isInfo;
            
            // â˜…æ”¹è‰¯: å…¥åŠ›ãŒç©ºãªã‚‰å…¨å“¡ã€æ–‡å­—ãŒã‚ã‚Œã°ä¸€è‡´åˆ¤å®š
            const matchPlayer = (playerVal === '') || (r.opponent === playerVal);
            return matchDate && matchPlayer;
        });

        if (filtered.length === 0) {
            container.innerHTML = "<div class='no-data'>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>";
            return;
        }

        filtered.forEach(r => {
            let badgeClass = '';
            if (r.match_type.includes('å¯¾æˆ¦')) badgeClass = 'bg-blue';
            else if (r.match_type.includes('è¦³æˆ¦')) badgeClass = 'bg-green';
            else badgeClass = 'bg-orange';

            const html = `
                <div class="record-card">
                    <div class="record-header">
                        <span>${r.date}</span>
                        <span class="match-badge ${badgeClass}">${r.match_type}</span>
                    </div>
                    <div class="record-title">VS ${r.opponent}</div>
                    <div style="font-size:0.9em; margin-bottom:5px; font-weight:bold;">${r.summary}</div>
                    <div style="font-size:0.85em; color:#555; white-space: pre-wrap;">${r.note}</div>
                </div>
            `;
            container.innerHTML += html;
        });
    }
</script>

</body>
</html>